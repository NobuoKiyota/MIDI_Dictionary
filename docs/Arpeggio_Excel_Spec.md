# Arpeggiator Excel Pattern Specification (V1.7)

本ドキュメントは、ユーザーがアルペジオパターンを定義するためのExcelファイル (`arpeggio_patterns.xlsx`) の構造と、プログラムによる解釈の仕様を定義します。

## 1. 概要
ユーザーはExcel上で16ステップのシーケンサーとしてパターンを視覚的に編集できます。プログラム起動時にこのファイルを読み込み、`ExternalArpStyle` として動的にスタイルを登録します。

## 2. Excelファイル構造
*   **ファイル名**: `scripts/arpeggio_patterns.xlsx`
*   **シート**: `Patterns` (または最初のシート)
*   **ヘッダー行**: 1行目にカラム名を記述
*   **データ行**: 2行目以降に各スタイルの定義を記述

### カラム定義 (合計50カラム + α)

| グループ | カラム名 | データ型 | 説明 |
| :--- | :--- | :--- | :--- |
| **基本設定** | `style_name` | String | スタイル名 (Generatorで使用するキー) |
| | `swing` | Float | スウィング感 (偶数ステップへの遅延秒数。例: 0.03) |
| **Sequence** | `s01` ... `s16` | String | 各ステップの発音ノートインデックス (0, 1, 2...)。`-1`は休符。複数指定(`0,1`)でコード/ストラミング。 |
| **Gate** | `g01` ... `g16` | Float | 各ステップの音価倍率 (1.0=16分音符)。`2.0`で次のステップまで繋がる。 |
| **Velocity** | `v01` ... `v16` | Float | 各ステップのベロシティ倍率 (1.0=標準)。強弱表現に使用。 |

### 詳細仕様

#### Sequence (`s01` - `s16`)
*   **値**: コード構成音のインデックス (0=ルート, 1=3rd, 2=5th...)
*   **休符**: `r` (大文字小文字問わず)
*   **オクターブ・ラッピング**: インデックスがコード構成音数を超えた場合、自動的にオクターブ上にシフトします。
    *   例: トライアド(3音)でインデックス`4`を指定 -> `4 % 3 = 1` (3rd) の音を `4 // 3 = 1` オクターブ上で発音。
*   **ストラミング**: セル内にカンマ区切りで複数の数値を記述可能 (例: `"0,1,2"`)。

#### Gate (`g01` - `g16`)
*   **値**: 整数値 (プログラム側で 0.1倍して使用)。
*   **10**: 1.0 (16分音符)
*   **5**: 0.5 (スタッカート)
*   **20**: 2.0 (Tie/Sustain, 次のステップまで)

#### Velocity (`v01` - `v16`)
*   **値**: 整数値 (プログラム側で 0.1倍して使用)。
*   **10**: 1.0 (標準)
*   **12**: 1.2 (アクセント)
*   **8**: 0.8 (ゴーストノート)

#### Swing (`swing`)
*   **値**: 秒単位の遅延時間 (例: `0.03` = 30ms)。
*   **適用**: 偶数番目のステップ (s02, s04, ...) の発音タイミングを遅らせ、跳ねるようなリズムを作ります。

## 3. Python実装要件 (`ExternalArpStyle`)

### 読み込み処理 (`load_arp_catalog`)
`pandas` を使用してExcelを読み込み、カラム名プレフィックス (`s`, `g`, `v`) に基づいて各ステップの配列を構築します。

```python
# 疑似コード
sequence = [row[f's{i:02}'] for i in range(1, 17)]
gates = [row[f'g{i:02}'] for i in range(1, 17)]
vels = [row[f'v{i:02}'] for i in range(1, 17)]
```

### 再生ロジック (`apply`)
既存の `ExternalArpStyle` ロジックを、この展開された配列データを使用するように適合させます。

---
**作成者**: Antigravity
**日付**: 2026/01/24
