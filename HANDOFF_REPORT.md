# MIDI Dictionary 作業引継ぎ資料

**最終更新日:** 2026-01-23

## 1. 環境セットアップ（会社PCなど別環境への移行時）

新しい環境でこのプロジェクトを実行する場合、以下の手順でセットアップを行ってください。

1.  **`Z:\MIDI_Dictionary`** フォルダを開きます。
2.  **`setup_and_run.bat`** をダブルクリックして実行します。
    *   自動的に仮想環境（`.venv`）が作成され、必要なライブラリ（`pygame`, `PySide6` など）がインストールされます。
    *   完了するとアプリケーションが起動します。

### トラブルシューティング
*   **"Permission Denied" エラーが出る場合:**
    *   VS Code やターミナルなど、このフォルダを開いているアプリケーションを全て閉じてから、**`force_reinstall.bat`** を実行してください。これにより環境がクリーンインストールされます。
    *   ※ファイルロックが原因で `.venv` が削除できないケースが多いためです。

---

## 2. 実装された新機能・変更点

### GUI / Excel のプルダウン対応 & 定数対応
*   **Key, Category, Instruments, Chord** の項目について、リストデータ定義を `ui_constants.py` に集約しました。
*   **GUI:** 登録ダイアログ（RegistrationDialog）ですべてプルダウン選択になりました。
*   **Excel:** 出力される `local_db_name.xlsx` の該当列に「データの入力規則」が設定され、Excel上でもプルダウン選択が可能になりました。

### 表記・フォーマットの変更
| 項目 | 変更前 | 変更後 | 備考 |
| :--- | :--- | :--- | :--- |
| **Key (Root)** | No / C / C#... | **- / C / Cs...** | `No` は `-` に変更。シャープ `#` は `s` 表記に統一。 |
| **Instruments** | - | **Standard Drum Kit** | ドラム音源が選択可能になりました。 |
| **小節単位** | Measure / Bar | **BAR** | リストヘッダーおよびフィルタ項目名を `BAR` に統一。 |
| **Category** | - | - | 定義済みリスト（`Rythem`, `Bass`, `Chord`...）に統一済み。 |

### MIDI登録ロジックの改良（`midi_analyzer.py`）
1.  **ファイル名生成ルールの変更:**
    *   形式: `[Style]_[Instrument]_[Suffix]`
    *   **Style**（Midiブロック名相当）を先頭（Prefix）に追加しました。
    *   **小節数（例: 4.4）** をサフィックスから削除しました。
2.  **ドラム（Ch10）の自動検出:**
    *   MIDIチャンネル10が含まれる場合、以下のメタデータを自動設定します。
        *   **Key**: `-`
        *   **Category**: `Rythem`
        *   **Chord**: `None`

---

## 3. バグ修正

*   **UnboundLocalError の修正:** 登録ダイアログでの変数スコープエラーを修正しまいた。
*   **ファイル名サニタイズ:** ファイル名入力欄に誤ってエラーメッセージや改行コードなどをペーストして保存しても、クラッシュしないように自動修正（`_`へ置換）する機能を追加しました。

---

## 4. ファイル構成
*   `setup_and_run.bat`: 通常起動用スクリプト
*   `force_reinstall.bat`: 環境再構築用スクリプト（トラブル時）
*   `ui_constants.py`: リスト定義（Key, Categoryなど）の集約場所
*   `instrument_config.py`: 楽器リスト定義
*   `midi_utils.py`: MIDI分析およびファイル操作（サニタイズ処理など）
