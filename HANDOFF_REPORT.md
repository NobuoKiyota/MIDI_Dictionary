# MIDI Dictionary 作業引継ぎ資料

**最終更新日:** 2026-01-26

## 1. Ensemble Generator Ver 1.8.1 (新機能)

スケール展開機能（Scale Expansion）が大幅に強化されました。
各コードタイプごとに個別の設定が可能になり、より細かなバリエーション生成が行えます。

### 主な変更点
*   **Expansion Settings (GUI)**:
    *   **Triad**: 3和音のみを生成対象にします。
    *   **7th**: 4和音（M7, m7等）を生成します。
    *   **Harmonic/Melodic Min**: マイナースケール固有のコードを生成します。
    *   **Tension**: 9th, 11th（Available Tension）を含むコードを生成します。
    *   **Strict Voice Check**: スタイル側のボイス数がコード構成音より少ない場合（例: 3音のパッドで9thコード）、生成をスキップする機能を追加しました。
*   **Style Filter**: デフォルトで「チェックなし（全スタイル対象）」に変更しました。Rename_src（Group名）に基づいた動的なフィルタリングが可能です。

## 2. 不具合修正・改善

### MIDI生成・パターンの読み込み
*   **Excelパターンの長さ拡張**: 以前は16ステップ（1小節）までしか読み込めませんでしたが、**最大128ステップ（8小節）**まで対応しました。
*   **Swingの計算式修正**: Swing値（0.3など）が絶対時間として加算されテンポが崩れていた問題を修正し、**比率（Ratio）**として正しく処理されるようにしました。
*   **列名の認識**: Excelの列名が `01`, `1`, 数値の `1` のいずれでも正しく読み込まれるように堅牢化しました。

### アプリケーション統合・安定性
*   **MasterLibraly統合ロジック**: `MIDI_Library` 内のファイルを読み込む際、サブフォルダ（`DESKTOP-KIYOTA2/Pad` など）も**再帰的（Recursive）**に検索するように修正しました。これにより、フォルダ分けされたExcelファイルも正しく統合されます。
*   **Reload Excelのキャッシュクリア**: GUIの「Reload Excel」ボタン押下時、メモリ上の古いスタイル定義を確実に消去してから再読み込みするようにしました。
*   **MidiAnalyzerの修正**: メインアプリ（Registration Dialog）から `midi_utils.py` を経由して `MidiAnalyzer` を呼ぶ際、パス設定や引数不足でエラーになっていた問題を修正しました。

## 3. 生成後のマスタ登録サポート

MIDI生成完了時に、登録用Excelファイル **`_Import_Source.xlsx`** が出力フォルダ内に自動作成されるようになりました。
このファイルには `MasterLibraly.xlsx` と互換性のある以下の列が含まれています。

*   **FileName / FilePath**
*   **Category** (Ensemble等) / **Instruments** (Style名)
*   **Bar** (小節数) / **Chord** / **Root**
*   **Group** (Excelで指定した rename_src)

**登録手順**:
1.  生成されたMIDIファイルを `MIDI_Library` 配下の任意フォルダに移動します。
2.  同フォルダに `_Import_Source.xlsx`（またはその行）を追加（コピー）します。
3.  アプリを再起動すると自動的に統合されます。

---
## 4. 今後のTODO / 注意点
*   **フォルダ構成**: 生成物をライブラリに移動する際、必ず対応するExcel情報も移動（または追記）してください。MIDIファイル単体ではマスタに表示されません。
*   `ui_constants.py`: メインアプリのドロップダウンリスト（Category, Chord等）を変更したい場合はこのファイルを編集してください。

---
## 5. MIDI Checker Tool (GUI)
ライブラリの整合性をチェックするためのツールです。
メインアプリ (`run.bat`) のメニューバー `Tools` -> `MIDI Checker Tool...` から起動できます。
また、`DragDrop_MidiChecker.bat` を実行して単独で起動することも可能です。

*   **使い方**: フォルダをウィンドウにドラッグ＆ドロップしてください。
*   **機能**: 
    1.  **Overlap**: 同じ音程のノートの重なり（ドラム以外）を検知。
    2.  **Duration**: MIDIの長さをミリ秒で出力。
    3.  **Auto Fix (自動修正)**:
        *   GUIのチェックボックスを有効にすると、重なったノートの前の音を **5 tick 短縮** して解消を試みます。
        *   **Max Iterations**: 修正を試みる最大回数（デフォルト10回）。
        *   **Backup**: 修正前のファイルは `.mid.bak` として保存されます。
*   **出力**: 対象フォルダの親階層に `[フォルダ名]_check.xlsx` を出力します。

---
## 6. 環境移行用パッケージ
ルートディレクトリに `MIDI_Dictionary_Release.zip` を作成しました。
これには `MIDI_Library` を含むプロジェクト一式が含まれています（`.git`, `.venv` 除外）。

**移行手順**:
1.  移行先PCに `MIDI_Dictionary_Release.zip` をコピーし、解凍します。
2.  解凍したフォルダ内で `setup_and_run.bat` を実行します。
    *   Python仮想環境が構築され、依存ライブラリがインストールされます。
3.  アプリが起動すれば移行完了です。


